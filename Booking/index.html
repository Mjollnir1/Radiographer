<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUT Radiology Clinic - Single File</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Login form validation styles */
        .error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }

        .success {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
        }

        /* Smooth transitions for form elements */
        input[type="email"], input[type="tel"], input[type="password"] {
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        /* Phone number input formatting */
        #login-phone, #register-phone {
            font-family: monospace;
            letter-spacing: 1px;
        }

        /* Hidden sections initially */
        .hidden-section {
            display: none;
        }

        /* Iframe styling (for potential future use, based on original HTML) */
        iframe {
            border: 0;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="mb-4 md:mb-6">
        <button id="sidebar-toggle" class="md:hidden inline-flex items-center gap-2 px-3 py-2 rounded border border-gray-300 text-gray-700 bg-white shadow-sm">
            <span>Menu</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
            </svg>
        </button>
        <h1 class="text-3xl font-bold text-indigo-700">DUT Radiology Clinic</h1>
    </div>

    <div class="flex">
        <nav id="sidebar" class="hidden md:block w-64 bg-white p-4 shadow-xl rounded-lg flex-shrink-0 mr-4 h-full">
            <h2 class="text-lg font-semibold mb-4 text-gray-700">Navigation</h2>
            <ul class="space-y-2">
                <li><a href="#" data-section-id="login-container" class="nav-link block px-3 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-md">Login</a></li>
                <li><a href="#" data-section-id="register-container" class="nav-link block px-3 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-md">Create Account</a></li>
                <li>
                    <button id="dashboards-toggle" class="w-full flex justify-between items-center px-3 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-md">
                        <span>Dashboards</span>
                        <svg id="dashboards-caret" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform transition-transform" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <ul id="dashboards-group" class="pl-4 mt-2 space-y-1 hidden">
                        <li><a href="#" data-section-id="patient-interface" class="nav-link block px-3 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-md">Patient</a></li>
                        <li><a href="#" data-section-id="radiographer-interface" class="nav-link block px-3 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-md">Radiographer</a></li>
                        <li><a href="#" data-section-id="admin-interface" class="nav-link block px-3 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-md">Admin</a></li>
                        <li><a href="#" data-section-id="student-interface" class="nav-link block px-3 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-md">Student</a></li>
                    
                    </ul>
                </li>
                <li><a href="reset.html" class="block px-3 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-md">Reset Password</a></li>
            </ul>
        </nav>

        <main class="flex-1 min-w-0">
            <div id="login-container" class="active-section max-w-md mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-10 border border-gray-200">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">User Login</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                        <p id="email-error" class="mt-1 text-sm text-red-500 hidden"></p>
                    </div>
                    <div>
                        <label for="login-phone" class="block text-sm font-medium text-gray-700">Phone (10 digits)</label>
                        <input type="tel" id="login-phone" required maxlength="10" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                        <p id="phone-error" class="mt-1 text-sm text-red-500 hidden"></p>
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                        <p id="password-error" class="mt-1 text-sm text-red-500 hidden"></p>
                    </div>
                    <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Log In</button>
                </form>
                <p id="login-message" class="mt-4 text-center"></p>
                <div class="mt-6 text-center text-sm">
                    <a href="#" data-section-id="register-container" class="font-medium text-indigo-600 hover:text-indigo-500 nav-link">Create an Account</a> | 
                    <a href="reset.html" class="font-medium text-indigo-600 hover:text-indigo-500">Forgot Password?</a>
                </div>
            </div>

            <div id="register-container" class="active-section hidden-section max-w-md mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-10 border border-gray-200">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Create Account</h2>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="register-name">Full Name</label>
                        <input id="register-name" type="text" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                        <p id="register-name-error" class="mt-1 text-sm text-red-500 hidden"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="register-email">Email Address</label>
                        <input id="register-email" type="email" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                        <p id="register-email-error" class="mt-1 text-sm text-red-500 hidden"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="register-phone">Phone (10 digits)</label>
                        <input id="register-phone" type="tel" maxlength="10" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                        <p id="register-phone-error" class="mt-1 text-sm text-red-500 hidden"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="register-password">Password</label>
                        <input id="register-password" type="password" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                        <p id="register-password-error" class="mt-1 text-sm text-red-500 hidden"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="register-role">Role</label>
                        <select id="register-role" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border bg-white">
                            <option value="">Select role</option>
                            <option value="Admin">Admin</option>
                            <option value="Patient">Patient</option>
                            <option value="Radiographer">Radiographer</option>
                            <option value="Student">Student</option>

                            
                        </select>
                        <p id="register-role-error" class="mt-1 text-sm text-red-500 hidden"></p>
                    </div>
                    <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Create Account</button>
                </form>
                <p id="register-message" class="mt-4 text-center"></p>
                <div class="mt-6 text-center text-sm">
                    <a href="#" data-section-id="login-container" class="font-medium text-indigo-600 hover:text-indigo-500 nav-link">Already have an account? Log In</a>
                </div>
            </div>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 hidden-section">
                <p class="text-sm text-gray-700">Logged in as: <span id="user-id" class="font-semibold text-indigo-600"></span></p>
                <div id="today-alert-container" class="mt-2 p-2 bg-yellow-100 text-yellow-800 rounded-md hidden">
                    <p class="text-sm font-medium">⚠️ Reminder: You have an appointment today!</p>
                </div>
            </div>

            <div id="patient-interface" class="active-section hidden-section">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Book Appointment</h2>
                <div class="max-w-xl bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8">
                    <form id="appointment-form" class="space-y-4">
                        <div>
                            <label for="patient-name" class="block text-sm font-medium text-gray-700">Patient Name</label>
                            <input type="text" id="patient-name" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="appointment-date" class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="appointment-date" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                            </div>
                            <div>
                                <label for="appointment-time" class="block text-sm font-medium text-gray-700">Time (08:00 - 17:00)</label>
                                <input type="time" id="appointment-time" required min="08:00" max="17:00" step="3600" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                            </div>
                        </div>
                        <div>
                            <label for="consultation-type" class="block text-sm font-medium text-gray-700">Consultation Type</label>
                            <select id="consultation-type" required class="mt-1 block w-full rounded-md border-gray-300 p-2 border bg-white">
                                <option value="">Select a service</option>
                                <option value="X-Ray">X-Ray</option>
                                <option value="Ultrasound">Ultrasound</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-green-600 hover:bg-green-700">Book Now</button>
                    </form>
                    <p id="form-message" class="mt-4 text-center"></p>
                </div>

                <h2 class="text-2xl font-bold mb-4 text-gray-800">My Appointments</h2>
                <div id="loading-message" class="text-center text-gray-500">Loading appointments...</div>
                <div id="appointments-list" class="space-y-4">
                    </div>
            </div>

            <div id="radiographer-interface" class="active-section hidden-section">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Radiographer Dashboard: All Appointments</h2>
                <div class="mb-4 flex space-x-4 bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700">Filter by Status:</label>
                    <select id="status-filter" class="rounded-md border-gray-300 border p-1 bg-white">
                        <option value="all">All</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="completed">Completed</option>
                    </select>
                    <label class="block text-sm font-medium text-gray-700">Filter by Date:</label>
                    <input type="date" id="date-filter" class="rounded-md border-gray-300 border p-1">
                </div>
                <div id="staff-loading-message" class="text-center text-gray-500">Loading appointments...</div>
                <div id="staff-appointments-list" class="space-y-4">
                    </div>
            </div>

            <div id="admin-interface" class="active-section hidden-section">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Admin Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-200">
                        <p class="text-sm font-medium text-gray-500">Total Appointments</p>
                        <p id="total-appointments" class="text-3xl font-bold text-indigo-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-green-200">
                        <p class="text-sm font-medium text-gray-500">Active Users</p>
                        <p id="active-users" class="text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-yellow-200">
                        <p class="text-sm font-medium text-gray-500">Appointments Today</p>
                        <p id="today-appointments" class="text-3xl font-bold text-yellow-600">0</p>
                    </div>
                </div>

                <h3 class="text-xl font-bold mb-4 text-gray-800">All Appointments Management</h3>
                <div id="admin-appointments-list" class="space-y-4">
                    </div>
            </div>

            <div class="mt-8 text-center text-sm text-gray-500 hidden-section">
                <p>Application ID: <span class="font-mono text-xs text-gray-400">Default-App-ID (Using Local Storage)</span></p>
            </div>
        </main>
    </div>

    <script>
        // --- Sidebar/Navigation Logic (Original index.html script) ---
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const navLinks = document.querySelectorAll('.nav-link');
            const activeSections = document.querySelectorAll('.active-section');
            const dashboardsToggle = document.getElementById('dashboards-toggle');
            const dashboardsGroup = document.getElementById('dashboards-group');
            const dashboardsCaret = document.getElementById('dashboards-caret');
            const dashboardIds = new Set(['client-interface', 'staff-interface', 'admin-interface']);
            
            // Initial state for dashboard dropdown
            const isDashboardsOpen = localStorage.getItem('dashboardsOpen') === 'true';
            if (isDashboardsOpen) {
                if (dashboardsGroup) dashboardsGroup.classList.remove('hidden');
                if (dashboardsCaret) dashboardsCaret.style.transform = 'rotate(180deg)';
            }
            
            if (dashboardsToggle) {
                dashboardsToggle.addEventListener('click', () => {
                    const isOpen = dashboardsGroup.classList.toggle('hidden');
                    if (dashboardsCaret) dashboardsCaret.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
                    localStorage.setItem('dashboardsOpen', !isOpen);
                });
            }

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('hidden');
                });
            }

            function setActive(sectionId) {
                activeSections.forEach(section => {
                    section.classList.add('hidden-section');
                });
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.remove('hidden-section');
                }
                navLinks.forEach(link => {
                    link.classList.remove('bg-indigo-100', 'text-indigo-700', 'font-semibold');
                    if (link.getAttribute('data-section-id') === sectionId) {
                        link.classList.add('bg-indigo-100', 'text-indigo-700', 'font-semibold');
                    }
                });
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = link.getAttribute('data-section-id');
                    if (sectionId) {
                        localStorage.setItem('activeSection', sectionId);
                        if (dashboardIds.has(sectionId)) {
                            localStorage.setItem('lastDashboard', sectionId);
                            if (dashboardsGroup && dashboardsGroup.classList.contains('hidden')) {
                                dashboardsGroup.classList.remove('hidden');
                                if (dashboardsCaret) dashboardsCaret.style.transform = 'rotate(180deg)';
                                localStorage.setItem('dashboardsOpen', 'true');
                            }
                        }
                        setActive(sectionId);
                        if (window.innerWidth < 768) {
                            sidebar.classList.add('hidden');
                        }
                    }
                });
            });

            // Initialize active state based on persisted section, prefer last dashboard if relevant
            let initial = localStorage.getItem('activeSection') || 'login-container';
            const lastDash = localStorage.getItem('lastDashboard');
            if (lastDash && dashboardIds.has(lastDash)) {
                initial = lastDash;
            }
            setActive(initial);
        });
    </script>
    
    <script type="module">
        /**
         * @fileoverview Consolidated script file for the Radiology Clinic application.
         * This file combines authentication logic (originally auth.js) and the main
         * application logic (originally script.js) into a single module.
         */

        // Documentation/Schema Reference (from database-schema.md)
        /*
        [... Database Schema Comment omitted for brevity ...]
        */

        // --- Start of AUTH Logic (Combined from auth.js) ---

        /**
         * Loads the user array from Local Storage.
         */
        function loadUsers() {
            try {
                return JSON.parse(localStorage.getItem('users') || '[]');
            } catch (_) {
                return [];
            }
        }

        /**
         * Saves the user array to Local Storage.
         */
        function saveUsers(users) {
            localStorage.setItem('users', JSON.stringify(users));
        }

        /**
         * Finds a user by email, ignoring case.
         */
        function findUserByEmail(email) {
            const users = loadUsers();
            return users.find(u => u.email.toLowerCase() === email.toLowerCase()) || null;
        }

        /**
         * Registers a new user.
         */
        function registerUser({ name, email, password, role, phone }) {
            const users = loadUsers();
            // Default role to 'client' if not provided (should be enforced by form validation)
            const finalRole = role || 'client'; 
            
            if (users.some(u => u.email.toLowerCase() === email.toLowerCase())) {
                return { ok: false, error: 'Email already registered' };
            }
            
            const user = {
                id: 'user_' + Date.now(),
                name,
                email,
                password,
                role: finalRole,
                phone: phone || '',
                createdAt: new Date().toISOString()
            };
            users.push(user);
            saveUsers(users);
            return { ok: true, user };
        }

        /**
         * Logs in a user by checking email and password.
         */
        function loginUser({ email, password }) {
            const user = findUserByEmail(email);
            if (!user) return { ok: false, error: 'Account not found' };
            if (user.password !== password) return { ok: false, error: 'Incorrect password' };
            return { ok: true, user };
        }

        // --- End of AUTH Logic ---


        // --- Start of Main Script Logic (Combined from script.js) ---

        // Firebase Imports (Kept for reference, but logic is Local Storage based)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // setLogLevel('debug'); // Commented out to reduce console noise
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let app, db, auth;
        try {
            // Firebase initialization omitted to strictly use Local Storage
            // app = initializeApp(firebaseConfig);
            // db = getFirestore(app);
            // auth = getAuth(app);
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        const form = document.getElementById('appointment-form');
        const appointmentsList = document.getElementById('appointments-list');
        const loadingMessage = document.getElementById('loading-message');
        const formMessage = document.getElementById('form-message');
        const userIdDisplay = document.getElementById('user-id');
        const todayAlertContainer = document.getElementById('today-alert-container');

        // Login elements
        const loginForm = document.getElementById('login-form');
        const loginMessage = document.getElementById('login-message');
        const emailError = document.getElementById('email-error');
        const phoneError = document.getElementById('phone-error');
        const passwordError = document.getElementById('password-error');
        
        // **NEW** Registration elements
        const registerForm = document.getElementById('register-form');
        const registerMessage = document.getElementById('register-message');
        
        // Interface elements
        const staffInterface = document.getElementById('staff-interface');
        const clientInterface = document.getElementById('client-interface');
        const adminInterface = document.getElementById('admin-interface');
        const staffAppointmentsList = document.getElementById('staff-appointments-list');
        const adminAppointmentsList = document.getElementById('admin-appointments-list');
        const statusFilter = document.getElementById('status-filter');
        const dateFilter = document.getElementById('date-filter');

        let userId = null;
        let userRole = null;
        let currentUser = null;

        // --- VALIDATION FUNCTIONS ---
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        function validatePhone(phone) {
            const phoneRegex = /^\d{10}$/;
            return phoneRegex.test(phone);
        }
        function validatePassword(password) {
            if (password.length < 8) {
                return { valid: false, message: 'Password must be at least 8 characters long' };
            }
            const hasSymbolOrNumber = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?0-9]/.test(password);
            if (!hasSymbolOrNumber) {
                return { valid: false, message: 'Password must contain at least 1 symbol or number' };
            }
            return { valid: true, message: '' };
        }
        
        // --- ERROR UTILITY FUNCTIONS ---
        function clearLoginErrors() {
            document.querySelectorAll('#login-form p[id$="-error"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('#login-form input').forEach(input => {
                input.classList.remove('error', 'success');
            });
            loginMessage.textContent = '';
        }
        function clearRegisterErrors() {
             document.querySelectorAll('#register-form p[id$="-error"]').forEach(el => el.classList.add('hidden'));
             document.querySelectorAll('#register-form input, #register-form select').forEach(input => {
                input.classList.remove('error', 'success');
            });
            registerMessage.textContent = '';
        }
        function showFormError(formId, field, message) {
            const errorElement = document.getElementById(`${formId}-${field}-error`) || document.getElementById(`${field}-error`);
            const inputElement = document.getElementById(`${formId}-${field}`) || document.getElementById(field);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
            }
            if (inputElement) {
                inputElement.classList.remove('success');
                inputElement.classList.add('error');
            }
        }
        function clearFormError(formId, field) {
            const errorElement = document.getElementById(`${formId}-${field}-error`) || document.getElementById(`${field}-error`);
            const inputElement = document.getElementById(`${formId}-${field}`) || document.getElementById(field);
            if (errorElement) {
                errorElement.classList.add('hidden');
                errorElement.textContent = '';
            }
            if (inputElement) {
                inputElement.classList.remove('error');
            }
        }

        // --- REGISTRATION HANDLER ---
        async function handleRegistration(event) {
            event.preventDefault();
            clearRegisterErrors();
            
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const phone = document.getElementById('register-phone').value.trim();
            const password = document.getElementById('register-password').value;
            const role = document.getElementById('register-role').value;

            let isValid = true;
            let firstInvalidField = null;

            if (!name) {
                showFormError('register', 'name', 'Full Name is required');
                isValid = false;
                if (!firstInvalidField) firstInvalidField = 'register-name';
            } else {
                clearFormError('register', 'name');
            }

            if (!email) {
                showFormError('register', 'email', 'Email is required');
                isValid = false;
                if (!firstInvalidField) firstInvalidField = 'register-email';
            } else if (!validateEmail(email)) {
                showFormError('register', 'email', 'Please enter a valid email address');
                isValid = false;
                if (!firstInvalidField) firstInvalidField = 'register-email';
            } else {
                clearFormError('register', 'email');
            }
            
            // Phone is optional based on register.html but validated if present
            if (phone && !validatePhone(phone)) {
                showFormError('register', 'phone', 'Phone number must be exactly 10 digits');
                isValid = false;
                if (!firstInvalidField) firstInvalidField = 'register-phone';
            } else {
                clearFormError('register', 'phone');
            }

            if (!password) {
                showFormError('register', 'password', 'Password is required');
                isValid = false;
                if (!firstInvalidField) firstInvalidField = 'register-password';
            } else {
                const passwordValidation = validatePassword(password);
                if (!passwordValidation.valid) {
                    showFormError('register', 'password', passwordValidation.message);
                    isValid = false;
                    if (!firstInvalidField) firstInvalidField = 'register-password';
                } else {
                    clearFormError('register', 'password');
                }
            }

            if (!role) {
                showFormError('register', 'role', 'Role is required');
                isValid = false;
                if (!firstInvalidField) firstInvalidField = 'register-role';
            } else {
                clearFormError('register', 'role');
            }
            
            if (!isValid) {
                registerMessage.textContent = 'Please fix the errors above to create your account.';
                registerMessage.className = 'mt-4 text-center text-red-500';
                // Focus on the first invalid field
                if (firstInvalidField) document.getElementById(firstInvalidField).focus();
                return;
            }

            const registerResult = registerUser({ name, email, password, role, phone });

            if (!registerResult.ok) {
                showFormError('register', 'email', registerResult.error);
                registerMessage.textContent = registerResult.error || 'Registration failed.';
                registerMessage.className = 'mt-4 text-center text-red-500';
                return;
            }

            // Registration successful
            registerMessage.textContent = `Account created successfully! You can now log in as a ${registerResult.user.role}.`;
            registerMessage.className = 'mt-4 text-center text-green-500';
            registerForm.reset();
            
            // Optional: Automatically navigate to login after a delay
            setTimeout(() => {
                document.querySelector('a[data-section-id="login-container"]').click();
            }, 3000);
        }
        
        // --- LOGIN HANDLER ---
        async function handleLogin(event) {
            event.preventDefault();
            clearLoginErrors();

            const email = document.getElementById('login-email').value.trim();
            const phone = document.getElementById('login-phone').value.trim();
            const password = document.getElementById('login-password').value;

            let isValid = true;


            if (!email) {
                showFormError('login', 'email', 'Email is required');
                isValid = false;
            } else if (!validateEmail(email)) {
                showFormError('login', 'email', 'Please enter a valid email address');
                isValid = false;
            }
            if (!phone) {
                showFormError('login', 'phone', 'Phone number is required');
                isValid = false;
            } else if (!validatePhone(phone)) {
                showFormError('login', 'phone', 'Phone number must be exactly 10 digits');
                isValid = false;
            }
            if (!password) {
                showFormError('login', 'password', 'Password is required');
                isValid = false;
            } else {
                const passwordValidation = validatePassword(password);
                if (!passwordValidation.valid) {
                    showFormError('login', 'password', passwordValidation.message);
                    isValid = false;
                }
            }
            if (!isValid) {
                loginMessage.textContent = 'Please fix the errors above';
                loginMessage.className = 'mt-4 text-center text-red-500';
                return;
            }

            const loginResult = loginUser({ email, password });

            if (!loginResult.ok) {
                loginMessage.textContent = loginResult.error || 'Login failed. Please check your email and password.';
                loginMessage.className = 'mt-4 text-center text-red-500';
                return;
            }

            // Login successful
            currentUser = loginResult.user;
            userId = currentUser.id;
            userRole = currentUser.role;

            loginMessage.textContent = `Login successful! Welcome ${currentUser.name || currentUser.email} (${userRole}).`;
            loginMessage.className = 'mt-4 text-center text-green-500';
            loginForm.reset();
            
            const sectionIdMap = {
                'client': 'client-interface',
                'staff': 'staff-interface',
                'admin': 'admin-interface'
            };
            const targetSectionId = sectionIdMap[userRole] || 'client-interface';
            
            setTimeout(() => {
                document.getElementById('login-container').classList.add('hidden-section');
                localStorage.setItem('activeSection', targetSectionId);
                localStorage.setItem('lastDashboard', targetSectionId);
                showUserInterface(targetSectionId);
                
                // Trigger sidebar update for active link
                document.querySelector(`a[data-section-id="${targetSectionId}"]`).click();

            }, 500);
        }

        function showUserInterface(targetSectionId) {
            document.getElementById('today-alert-container').closest('div').classList.remove('hidden-section');
            document.querySelector('.mt-8.text-center').classList.remove('hidden-section');
            userIdDisplay.textContent = userId;
            
            // Hide all dashboard sections first
            document.querySelectorAll('.active-section').forEach(section => {
                if (section.id !== 'login-container' && section.id !== 'register-container') {
                    section.classList.add('hidden-section');
                }
            });

            // Show the target section and start listening for data
            const targetSection = document.getElementById(targetSectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden-section');
            }

            if (userRole === 'client') {
                listenForAppointments();
            } else if (userRole === 'staff') {
                listenForAllAppointments();
            } else if (userRole === 'admin') {
                listenForAllAppointments();
                updateAdminStats();
            }
        }

        // --- Event Listeners for Validation and Forms ---
        document.getElementById('login-email').addEventListener('input', function() {
            if (this.value.trim() && !validateEmail(this.value.trim())) {
                showFormError('login', 'email', 'Please enter a valid email address');
            } else {
                clearFormError('login', 'email');
            }
        });
        document.getElementById('login-phone').addEventListener('input', function() {
            if (this.value.trim() && !validatePhone(this.value.trim())) {
                showFormError('login', 'phone', 'Phone number must be exactly 10 digits');
            } else {
                clearFormError('login', 'phone');
            }
        });
        document.getElementById('login-password').addEventListener('input', function() {
            if (this.value) {
                const validation = validatePassword(this.value);
                if (!validation.valid) {
                    showFormError('login', 'password', validation.message);
                } else {
                    clearFormError('login', 'password');
                    this.classList.add('success');
                }
            } else {
                clearFormError('login', 'password');
            }
        });
        
        document.getElementById('register-email').addEventListener('input', function() {
            if (this.value.trim() && !validateEmail(this.value.trim())) {
                showFormError('register', 'email', 'Please enter a valid email address');
            } else {
                clearFormError('register', 'email');
            }
        });
        document.getElementById('register-phone').addEventListener('input', function() {
            if (this.value.trim() && !validatePhone(this.value.trim())) {
                showFormError('register', 'phone', 'Phone number must be exactly 10 digits');
            } else {
                clearFormError('register', 'phone');
            }
        });
        document.getElementById('register-password').addEventListener('input', function() {
            if (this.value) {
                const validation = validatePassword(this.value);
                if (!validation.valid) {
                    showFormError('register', 'password', validation.message);
                } else {
                    clearFormError('register', 'password');
                    this.classList.add('success');
                }
            } else {
                clearFormError('register', 'password');
            }
        });


        // --- APPOINTMENT/ADMIN/STAFF Logic (Omitted for brevity, preserved from previous turn) ---
        
        function listenForAllAppointments() {
            const staffLoadingMessage = document.getElementById('staff-loading-message');
            if (staffLoadingMessage) {
                staffLoadingMessage.classList.add('hidden');
            }
            
            let allAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            if (allAppointments.length === 0) {
                const today = new Date().toISOString().split('T')[0];
                const tomorrow = new Date(new Date().setDate(new Date().getDate() + 1)).toISOString().split('T')[0];
                const dayAfter = new Date(new Date().setDate(new Date().getDate() + 2)).toISOString().split('T')[0];
                const sampleAppointments = [
                    {
                        id: 'apt_1',
                        clientId: 'user_sample_1', 
                        patientName: 'John Doe',
                        appointmentDate: today, 
                        appointmentTime: '10:00',
                        consultationType: 'X-Ray',
                        status: 'scheduled',
                        clientEmail: 'john@example.com',
                        clientPhone: '1234567890',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'apt_2',
                        clientId: 'user_sample_2',
                        patientName: 'Jane Smith',
                        appointmentDate: tomorrow, 
                        appointmentTime: '14:00',
                        consultationType: 'MRI',
                        status: 'confirmed',
                        clientEmail: 'jane@example.com',
                        clientPhone: '0987654321',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'apt_3',
                        clientId: 'user_sample_3',
                        patientName: 'Bob Johnson',
                        appointmentDate: dayAfter, 
                        appointmentTime: '09:00',
                        consultationType: 'CT Scan',
                        status: 'completed',
                        clientEmail: 'bob@example.com',
                        clientPhone: '1122334455',
                        createdAt: new Date().toISOString()
                    }
                ];
                localStorage.setItem('appointments', JSON.stringify(sampleAppointments));
                allAppointments = sampleAppointments;
            }
            
            if (userRole === 'admin') {
                displayAdminAppointments(allAppointments);
            } else {
                displayStaffAppointments(allAppointments);
            }
        }

        function displayStaffAppointments(appointments) {
            staffAppointmentsList.innerHTML = '';
            if (appointments.length === 0) {
                staffAppointmentsList.innerHTML = '<p class="text-center text-gray-500">No appointments found.</p>';
                return;
            }
            
            // Re-bind listener on the list element via delegation
            const oldStaffAppointmentsList = staffAppointmentsList; 
            const newStaffAppointmentsList = oldStaffAppointmentsList.cloneNode(false); // Clone without children
            oldStaffAppointmentsList.parentNode.replaceChild(newStaffAppointmentsList, oldStaffAppointmentsList); 
            
            appointments.forEach(app => {
                const appointmentCard = document.createElement('div');
                appointmentCard.className = 'bg-gray-50 rounded-lg p-4 border border-gray-200 shadow-sm';
                const statusColor = {
                    'scheduled': 'text-yellow-600 bg-yellow-100',
                    'confirmed': 'text-green-600 bg-green-100',
                    'cancelled': 'text-red-600 bg-red-100',
                    'completed': 'text-blue-600 bg-blue-100'
                }[app.status] || 'text-gray-600 bg-gray-100';
                appointmentCard.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-800">${app.consultationType} for ${app.patientName}</h3>
                            <p class="text-gray-600 text-sm">Date: ${app.appointmentDate}</p>
                            <p class="text-gray-600 text-sm">Time: ${app.appointmentTime}</p>
                            <p class="text-gray-600 text-sm">Client: ${app.clientEmail}</p>
                            <p class="text-gray-600 text-sm">Phone: ${app.clientPhone}</p>
                            <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ${statusColor} mt-2">
                                ${app.status.charAt(0).toUpperCase() + app.status.slice(1)}
                            </span>
                        </div>
                        <div class="flex gap-2 mt-3 sm:mt-0">
                            <select class="status-update text-xs border rounded px-2 py-1" data-id="${app.id}">
                                <option value="scheduled" ${app.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                                <option value="confirmed" ${app.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                <option value="cancelled" ${app.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                <option value="completed" ${app.status === 'completed' ? 'selected' : ''}>Completed</option>
                            </select>
                            <button class="reschedule-btn text-xs px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700" data-id="${app.id}">
                                Reschedule
                            </button>
                        </div>
                    </div>
                `;
                newStaffAppointmentsList.appendChild(appointmentCard);
            });
            
            // Add event listeners to the new list element using delegation
            newStaffAppointmentsList.addEventListener('change', function(event) {
                if (event.target.classList.contains('status-update')) {
                    const appointmentId = event.target.getAttribute('data-id');
                    const newStatus = event.target.value;
                    updateAppointmentStatus(appointmentId, newStatus);
                }
            });
            newStaffAppointmentsList.addEventListener('click', function(event) {
                if (event.target.classList.contains('reschedule-btn')) {
                    const appointmentId = event.target.getAttribute('data-id');
                    rescheduleAppointment(appointmentId);
                }
            });
        }

        function updateAppointmentStatus(appointmentId, newStatus) {
            let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            const appointmentIndex = appointments.findIndex(app => app.id === appointmentId);
            if (appointmentIndex !== -1) {
                appointments[appointmentIndex].status = newStatus;
                appointments[appointmentIndex].updatedAt = new Date().toISOString();
                localStorage.setItem('appointments', JSON.stringify(appointments));
                if (userRole === 'admin') {
                    displayAdminAppointments(appointments);
                } else {
                    displayStaffAppointments(appointments);
                }
            }
            loginMessage.textContent = `Appointment status updated to ${newStatus}`;
            loginMessage.className = 'mt-4 text-center text-green-500';
            setTimeout(() => {
                loginMessage.textContent = '';
            }, 3000);
        }

        function rescheduleAppointment(appointmentId) {
            const newDate = prompt('Enter new date (YYYY-MM-DD):');
            const newTime = prompt('Enter new time (HH:MM):');
            if (newDate && newTime) {
                let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                const appointmentIndex = appointments.findIndex(app => app.id === appointmentId);
                if (appointmentIndex !== -1) {
                    appointments[appointmentIndex].appointmentDate = newDate;
                    appointments[appointmentIndex].appointmentTime = newTime;
                    appointments[appointmentIndex].updatedAt = new Date().toISOString();
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                    if (userRole === 'admin') {
                        displayAdminAppointments(appointments);
                    } else {
                        displayStaffAppointments(appointments);
                    }
                }
                loginMessage.textContent = `Appointment rescheduled to ${newDate} at ${newTime}`;
                loginMessage.className = 'mt-4 text-center text-green-500';
                setTimeout(() => {
                    loginMessage.textContent = '';
                }, 3000);
            }
        }

        function updateAdminStats() {
            const allAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            const totalAppointments = allAppointments.length;
            const today = new Date().toISOString().split('T')[0];
            const appointmentsToday = allAppointments.filter(app => app.appointmentDate === today).length;
            const activeUsers = loadUsers().length; 

            document.getElementById('total-appointments').textContent = totalAppointments;
            document.getElementById('active-users').textContent = activeUsers;
            document.getElementById('today-appointments').textContent = appointmentsToday;
        }

        function displayAdminAppointments(appointments) {
            adminAppointmentsList.innerHTML = '';
            if (appointments.length === 0) {
                adminAppointmentsList.innerHTML = '<p class="text-center text-gray-500">No appointments found.</p>';
                return;
            }
            
            const oldAdminAppointmentsList = adminAppointmentsList;
            const newAdminAppointmentsList = oldAdminAppointmentsList.cloneNode(false);
            oldAdminAppointmentsList.parentNode.replaceChild(newAdminAppointmentsList, oldAdminAppointmentsList); 

            appointments.forEach(app => {
                const appointmentCard = document.createElement('div');
                appointmentCard.className = 'bg-gray-50 rounded-lg p-4 border border-gray-200 shadow-sm';
                const statusColor = {
                    'scheduled': 'text-yellow-600 bg-yellow-100',
                    'confirmed': 'text-green-600 bg-green-100',
                    'cancelled': 'text-red-600 bg-red-100',
                    'completed': 'text-blue-600 bg-blue-100'
                }[app.status] || 'text-gray-600 bg-gray-100';

                appointmentCard.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-800">${app.consultationType} for ${app.patientName}</h3>
                            <p class="text-gray-600 text-sm">Date: ${app.appointmentDate}</p>
                            <p class="text-gray-600 text-sm">Time: ${app.appointmentTime}</p>
                            <p class="text-gray-600 text-sm">Client: ${app.clientEmail}</p>
                            <p class="text-gray-600 text-sm">Phone: ${app.clientPhone}</p>
                            <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ${statusColor} mt-2">
                                ${app.status.charAt(0).toUpperCase() + app.status.slice(1)}
                            </span>
                        </div>
                        <div class="flex gap-2 mt-3 sm:mt-0">
                            <select class="admin-status-update text-xs border rounded px-2 py-1" data-id="${app.id}">
                                <option value="scheduled" ${app.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                                <option value="confirmed" ${app.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                <option value="cancelled" ${app.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                <option value="completed" ${app.status === 'completed' ? 'selected' : ''}>Completed</option>
                            </select>
                            <button class="admin-reschedule-btn text-xs px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700" data-id="${app.id}">
                                Reschedule
                            </button>
                            <button class="admin-delete-btn text-xs px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700" data-id="${app.id}">
                                Delete
                            </button>
                        </div>
                    </div>
                `;

                newAdminAppointmentsList.appendChild(appointmentCard);
            });

            // Add event listeners for admin controls
            newAdminAppointmentsList.addEventListener('change', function(event) {
                if (event.target.classList.contains('admin-status-update')) {
                    const appointmentId = event.target.getAttribute('data-id');
                    const newStatus = event.target.value;
                    updateAppointmentStatus(appointmentId, newStatus);
                }
            });

            newAdminAppointmentsList.addEventListener('click', function(event) {
                if (event.target.classList.contains('admin-reschedule-btn')) {
                    const appointmentId = event.target.getAttribute('data-id');
                    rescheduleAppointment(appointmentId);
                } else if (event.target.classList.contains('admin-delete-btn')) {
                    const appointmentId = event.target.getAttribute('data-id');
                    deleteAppointment(appointmentId);
                }
            });
        }

        function deleteAppointment(appointmentId) {
            if (confirm('Are you sure you want to delete this appointment? This action cannot be undone.')) {
                let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                appointments = appointments.filter(app => app.id !== appointmentId);
                localStorage.setItem('appointments', JSON.stringify(appointments));
                displayAdminAppointments(appointments);
                loginMessage.textContent = 'Appointment deleted successfully';
                loginMessage.className = 'mt-4 text-center text-green-500';
                setTimeout(() => {
                    loginMessage.textContent = '';
                }, 3000);
            }
        }

        async function bookAppointment(event) {
            event.preventDefault();
            if (!userId || userRole !== 'client') {
                formMessage.textContent = 'Only clients can book appointments.';
                formMessage.className = 'mt-4 text-center text-red-500';
                return;
            }

            const patientName = document.getElementById('patient-name').value;
            const appointmentDate = document.getElementById('appointment-date').value;
            const appointmentTime = document.getElementById('appointment-time').value;
            const consultationType = document.getElementById('consultation-type').value;

            const date = new Date(appointmentDate);
            const dayOfWeek = date.getDay();
            const timeHours = parseInt(appointmentTime.split(':')[0]);
            
            if (dayOfWeek === 2) {
                formMessage.textContent = 'Sorry, the clinic is closed on Tuesdays. Please choose another day.';
                formMessage.className = 'mt-4 text-center text-red-500';
                return;
            }
            if (timeHours < 8 || timeHours >= 17) {
                formMessage.textContent = 'The clinic is only open from 08:00 to 17:00. Please choose a time within this range.';
                formMessage.className = 'mt-4 text-center text-red-500';
                return;
            }

            try {
                const appointment = {
                    id: 'apt_' + Date.now(),
                    patientName,
                    appointmentDate,
                    appointmentTime,
                    consultationType,
                    status: 'scheduled',
                    clientId: userId,
                    clientEmail: currentUser.email,
                    clientPhone: currentUser.phone,
                    createdAt: new Date().toISOString()
                };
                let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                appointments.push(appointment);
                localStorage.setItem('appointments', JSON.stringify(appointments));
                form.reset();
                formMessage.textContent = 'Appointment booked successfully!';
                formMessage.className = 'mt-4 text-center text-green-500';
                listenForAppointments();
            } catch (error) {
                console.error("Error booking appointment: ", error);
                formMessage.textContent = 'Error booking appointment. Please try again.';
                formMessage.className = 'mt-4 text-center text-red-500';
            }
        }

        function listenForAppointments() {
            loadingMessage.classList.add('hidden');
            appointmentsList.innerHTML = '';
            let hasAppointmentToday = false;
            const today = new Date().toISOString().split('T')[0];
            const allAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            
            const appointments = allAppointments.filter(app => app.clientId === userId);
            
            appointments.sort((a, b) => {
                const dateA = new Date(`${a.appointmentDate}T${a.appointmentTime}`);
                const dateB = new Date(`${b.appointmentDate}T${b.appointmentTime}`);
                return dateA - dateB;
            });
            
            if (appointments.length === 0) {
                appointmentsList.innerHTML = '<p class="text-center text-gray-500">No appointments found.</p>';
            } else {
                appointments.forEach(app => {
                    const appointmentDate = app.appointmentDate;
                    if (appointmentDate === today) {
                        hasAppointmentToday = true;
                    }
                    const appointmentCard = document.createElement('div');
                    appointmentCard.className = 'bg-gray-50 rounded-lg p-4 border border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center shadow-sm';
                    const statusColor = {
                        'scheduled': 'text-yellow-600 bg-yellow-100',
                        'confirmed': 'text-green-600 bg-green-100',
                        'cancelled': 'text-red-600 bg-red-100',
                        'completed': 'text-blue-600 bg-blue-100'
                    }[app.status] || 'text-gray-600 bg-gray-100';
                    
                    appointmentCard.innerHTML = `
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-800">${app.consultationType} for ${app.patientName}</h3>
                            <p class="text-gray-600 text-sm">Date: ${app.appointmentDate}</p>
                            <p class="text-gray-600 text-sm">Time: ${app.appointmentTime}</p>
                            <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ${statusColor} mt-2">
                                ${app.status ? app.status.charAt(0).toUpperCase() + app.status.slice(1) : 'Scheduled'}
                            </span>
                        </div>
                        <div class="flex gap-2 mt-3 sm:mt-0">
                            ${app.status !== 'cancelled' && app.status !== 'completed' ?
                                `<button data-id="${app.id}" class="delete-btn px-4 py-2 text-xs font-semibold text-red-600 border border-red-600 rounded-md hover:bg-red-50 transition-colors">Cancel</button>` :
                                ''
                            }
                        </div>
                    `;
                    appointmentsList.appendChild(appointmentCard);
                });
            }
            if (hasAppointmentToday) {
                todayAlertContainer.classList.remove('hidden');
            } else {
                todayAlertContainer.classList.add('hidden');
            }
        }

        appointmentsList.addEventListener('click', async (event) => {
            const target = event.target;
            if (target.classList.contains('delete-btn')) {
                const appointmentId = target.getAttribute('data-id');
                if (confirm('Are you sure you want to cancel this appointment?')) {
                    try {
                        let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                        const appointmentIndex = appointments.findIndex(app => app.id === appointmentId);
                        if (appointmentIndex !== -1) {
                            appointments[appointmentIndex].status = 'cancelled';
                            localStorage.setItem('appointments', JSON.stringify(appointments));
                            listenForAppointments();
                        }
                    } catch (error) {
                        console.error("Error cancelling appointment: ", error);
                    }
                }
            }
        });
        
        // --- FINAL FORM BINDINGS ---
        loginForm.addEventListener('submit', handleLogin);
        form.addEventListener('submit', bookAppointment);
        registerForm.addEventListener('submit', handleRegistration);

        // --- End of consolidated JavaScript content ---
    </script>
</body>
</html>